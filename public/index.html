<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dicey ‚Äî Dice distribution calculator and roller with advanced capabilities</title>
    <link rel="stylesheet" href="main.css">
    <link rel="icon" type="image/svg+xml" href="D12.svg">
    <link rel="icon" type="image/png" href="D12-192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="D12-512.png" sizes="512x512">
    <link rel="manifest" href="dicey.webmanifest">
</head>

<body>
    <noscript>
        <p>JavaScript is required to use this calculator. Sad but true.</p>
    </noscript>

    <div class="loader" id="loader" popover="manual">
        <div class="loader-spinner">&nbsp;</div>
        <script>
            document.getElementById("loader").showPopover();
        </script>
    </div>

    <div class="container">
        <header class="surface">
            <h1>Dicey</h1>
            <p>Dice distribution calculator and roller <i id="dicey-description">with advanced capabilities</i><i>!</i></p>
            <div id="install-button-container">
                <button class="standout-button mini-button install-button" id="install" hidden>Install as webapp</button>
            </div>
        </header>

        <div class="dice-selection surface" id="dice-selection">
            <div class="dice-buttons">
                <h2>Common dice</h2>
                <div class="dice-grid">
                    <button class="dice-button normal-button" data-die="D4" id="die-d4">
                        <svg viewBox="-10 -10 120 120">
                            <polygon points="50,10 100,90 30,100 0,85" />
                            <line x1="50" y1="10" x2="30" y2="100" />
                        </svg>
                        <span>D4</span>
                    </button>
                    <button class="dice-button normal-button" data-die="D6" id="die-d6">
                        <svg viewBox="-10 -10 120 120">
                            <polygon points="0,20 60,15 100,20 100,90 40,100 0,90" />
                            <polyline points="0,20 40,25 100,20" />
                            <polyline points="40,25 40,100" />
                        </svg>
                        <span>D6</span>
                    </button>
                    <button class="dice-button normal-button" data-die="D8" id="die-d8">
                        <svg viewBox="-10 -10 120 120">
                            <polygon points="50,0 0,50 50,100 100,55" />
                            <polyline points="0,50 25,60 100,55" />
                            <polyline points="50,0 25,60 50,100" />
                        </svg>
                        <span>D8</span>
                    </button>
                    <button class="dice-button normal-button" data-die="D10" id="die-d10">
                        <svg viewBox="-10 -10 120 120" id="die-d10-image">
                            <polygon points="50,0 95,40 95,55 50,95 5,55 5,40" />
                            <polyline points="5,55 25,45 50,60 75,45 95,55" />
                            <line x1="50" y1="0" x2="25" y2="45" />
                            <line x1="50" y1="0" x2="75" y2="45" />
                            <line x1="50" y1="95" x2="50" y2="60" />
                        </svg>
                        <span>D10</span>
                    </button>
                    <button class="dice-button normal-button" data-die="D12" id="die-d12">
                        <svg viewBox="-10 -10 120 120">
                            <polygon points="50,0 80,5 100,40 95,65 80,90 50,100 20,90 5,65 0,40 20,5" />
                            <polyline points="5,65 25,55 50,70 75,55 95,65" />
                            <polyline points="20,5 35,15 65,15 80,5" />
                            <line x1="35" y1="15" x2="25" y2="55" />
                            <line x1="65" y1="15" x2="75" y2="55" />
                            <line x1="50" y1="70" x2="50" y2="100" />
                        </svg>
                        <span>D12</span>
                    </button>
                    <button class="dice-button normal-button" data-die="D20" id="die-d20">
                        <svg viewBox="-10 -10 120 120">
                            <polygon points="50,0 95,20 95,75 50,100 5,75 5,20" />
                            <polyline points="5,20 25,35 75,35 95,20" />
                            <polyline points="5,75 25,35 50,80 75,35 95,75" />
                            <polyline points="5,75 50,80 95,75" />
                            <line x1="50" y1="0" x2="25" y2="35" />
                            <line x1="50" y1="0" x2="75" y2="35" />
                            <line x1="50" y1="80" x2="50" y2="100" />
                        </svg>
                        <span>D20</span>
                    </button>
                </div>
            </div>
            <div class="dice-buttons">
                <h2>Uncommon dice</h2>
                <div class="dice-grid">
                    <button class="dice-button normal-button" data-die="D100" id="die-d100">
                        <svg viewBox="-10 -10 120 120">
                            <g transform="translate(-20, 5)"><use href="#die-d10-image" width="80" height="80" transform="rotate(-10)" /></g>
                            <g transform="translate(50, 25)"><use href="#die-d10-image" width="80" height="80" transform="rotate(18)" /></g>
                        </svg>
                        <span>D100</span>
                    </button>
                    <button class="dice-button normal-button" data-die="üêµÔ∏è,üêíÔ∏è" id="die-coin">
                        <svg viewBox="-10 -10 120 120">
                            <ellipse cx="50" cy="65" rx="50" ry="30" />
                            <ellipse cx="50" cy="55" rx="50" ry="30" />
                            <text x="48" y="60" rotate="15">üêµÔ∏è</text>
                        </svg>
                        <span>Coin</span>
                    </button>
                    <button class="dice-button normal-button" data-die="üëë,‚ô†Ô∏è,‚ô•Ô∏è,‚ô£Ô∏è,‚ô¶Ô∏è,‚öìÔ∏è" id="die-crown-anchor">
                        <svg viewBox="-10 -10 120 120">
                            <polygon points="0,20 60,15 100,20 100,90 40,100 0,90" />
                            <polyline points="0,20 40,25 100,20" />
                            <polyline points="40,25 40,100" />
                            <text x="70" y="70" rotate="-6" lengthAdjust="spacingAndGlyphs" textLength="30">‚ô•Ô∏è</text>
                            <text x="20" y="65" rotate="6" lengthAdjust="spacingAndGlyphs" textLength="20">‚ô†Ô∏è</text>
                        </svg>
                        <span>üëë&‚öìÔ∏è</span>
                    </button>
                </div>
            </div>

            <div class="custom-dice">
                <h2>Custom dice</h2>
                <form action="javascript:void(0);" id="custom-dice-form">
                    <label for="custom-dice-input">Add a custom die:</label>
                    <div class="input-group">
                        <input type="text" placeholder="e.g. 2d3, -4..4, or 2,3,11,2" id="custom-dice-input"
                            pattern="\s*(?:(?:[1-9][0-9]*)?[Dd])?(?:[1-9][0-9]*|\(?-?[1-9][0-9]*(?:-|..|...|‚Äì|‚Äî|‚Ä¶)-?[1-9][0-9]*\)?|\(?-?[0-9]+(?:(?:,-?[0-9]+)+|,)\)?|\(?[^'&quot;\(\),]+(?:(?:,[^'&quot;\(\),]+)+|,)\)?)\s*"
                            enterkeyhint="done" oninput="(e) => e.target.checkValidity()">
                        <button class="standout-button" id="custom-dice-button">Add</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="selected-dice surface">
            <h2>Selected dice</h2>
            <div class="dice-list" id="selected-dice-list"></div>
        </div>

        <div class="roll-results surface">
            <h2>Roll results</h2>
            <div class="roll-output" id="roll-output"></div>
            <button class="standout-button reroll-button" id="reroll-button">Reroll</button>
        </div>

        <div class="distribution-results surface">
            <h2>Probability distribution</h2>
            <table id="results-table">
                <thead>
                    <tr>
                        <th scope="col"><span title="Total value of all dice, also known as outcome">Value</span></th>
                        <th scope="col"><span title="Number of distinct rolls that can produce this outcome">Weight</span></th>
                        <th scope="col"><span title="Probability of this outcome">Probability</span></th>
                        <th scope="col"><span title="Probability of this outcome relative to probability of most likely outcome">P/Mode</span></th>
                    </tr>
                </thead>
                <tbody id="results-table-body"></tbody>
            </table>
            <div id="empty-results-table">
                <p><i>Here be probabilities!</i></p>
                <p>But currently they aren't.</p>
            </div>
        </div>

        <footer class="surface">
            <nav>
                <p>¬©&nbsp;2025-2026&nbsp;<a href="https://bulancov.pro">Alexander&nbsp;Bulancov</a>.</p>
                <p>See <a href="https://github.com/trinistr/dicey">Dicey's repository</a> on GitHub for the underlying Ruby gem and <a href="https://github.com/trinistr/dicey.bulancov.tech">this webapp's repository</a> to see how it works in the browser.</p>
                <p>Suggestions are welcome!</p>
            </nav>
        </footer>

        <div id="footer-offline-data" class="surface">
            <div>
                <span>Offline/cached data:</span>
                <span id="offline-data-size">???</span>
            </div>
            <button class="danger-button mini-button" id="delete-data-button">Clear data</button>
        </div>
    </div>

    <script>
        const sample = (array) => array[Math.floor(Math.random() * array.length)];
        window.addEventListener("load", () => {
            const description = document.getElementById("dicey-description");
            description.textContent = sample(
                ["with advanced capabilities", "with exciting possibilities", "of questionable quality", "(may contain monkeys)", "backed by questionable math", "(consult your dice dealer)", "utilising synergistic rolling paradigms"]
            )
        });

        const loadRuby = () => {
            if (window.RUBY_INTERPRETER_LOADED) return;
            window.RUBY_INTERPRETER_LOADED = true;
            
            const script = document.createElement("script");
            script.src = "https://cdn.jsdelivr.net/npm/@ruby/3.4-wasm-wasi@2.7.2/dist/browser.script.iife.js";
            script.async = true;
            
            document.head.appendChild(script);
        }
        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.getRegistration().then((reg) => {
                if (reg?.active && !navigator.serviceWorker.controller) {
                    // There's an active SW, but no controller for this tab, reload.
                    // Happens after force-reload.
                    window.location.reload();
                }
            });
            navigator.serviceWorker.addEventListener("message", (event) => {
                if (event.data.type === "CACHE_SIZE_UPDATE") {
                    updateOfflineDataSize(event.data.size);
                }
            });
            window.addEventListener("load", async () => {
                try {
                    const registration = await navigator.serviceWorker.register("/worker.js");
                    if (registration.active) {
                        loadRuby();
                    }
                    else {
                        registration.installing.addEventListener('statechange', (e) => {
                            if (e.target.state === 'activated') {
                                loadRuby();
                            }
                        });
                    }

                    setTimeout(() => {
                        if (!window.RUBY_INTERPRETER_LOADED) {
                            console.warn("Service worker activation timeout, loading Ruby anyway");
                            loadRuby();
                        }
                    }, 5000);
                }
                catch (error) {
                    console.error(`Service worker registration failed: ${error}`);
                    loadRuby();
                }
            });
        }
        else {
            loadRuby();
            document.getElementById("footer-offline-data").style.display = "none";
        }

        const updateOfflineDataSize = (size) => {
            const element = document.querySelector("#offline-data-size");
            const sizeMB = (typeof size === "number") ? `reportedly ${Math.round(size / 1024 / 1024)} MB` : size
            element.textContent = sizeMB;
        };

        const deleteButton = document.querySelector("#delete-data-button");
        deleteButton.addEventListener("click", () => {
            if (confirm("Clear offline data?\n\nThis will delete all cached data this site has saved on your device. The site will work slower on your next visit as everything re-downloads.\n\nThis will not save space if the site is used again, normally, all cached data is cached for a reason.")) {
                navigator.serviceWorker.getRegistrations().then((registrations) => {
                    for (const registration of registrations) {
                        registration.unregister();
                    }
                });
                caches.keys().then((keys) => {
                    for (const key of keys) {
                        caches.delete(key);
                    }
                    updateOfflineDataSize("???");
                });
            }
        });

        let installEvent = null;
        const installButton = document.querySelector("#install");
        window.addEventListener("beforeinstallprompt", (event) => {
            event.preventDefault();
            installEvent = event;
            installButton.removeAttribute("hidden");
        });
        installButton.addEventListener("click", () => {
            if (installEvent) {
                installEvent.prompt().then(() => {
                    // On cancel, this happens, but "beforeinstallprompt" fires immediately again.
                    installEvent = null;
                    installButton.setAttribute("hidden", "");
                });
            }
        });
    </script>
    <script src="main.rb" type="text/ruby" data-eval="async"></script>
</body>

</html>
